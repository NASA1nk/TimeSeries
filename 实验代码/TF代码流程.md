# 数据处理

## 归一化

对数据做归一化处理,提升模型的收敛速度,提升模型的精度

## 训练集

处理原始数据集得到模型的训练集

- 每次从数据集中取出目标窗口（target_window）长度的数据
  - 数据集的(i,i+100)部分是输入，数据集的(i+1,i+100+1)部分是输出
  - 所以训练集（是一个list）为[([0-100],[1-101]),([1-101],[2-102])...]
  - 可以知道，**下一个输入的seq就是上一个输入的label**

- 将训练集转换为torch.Tensor

```json
// train_seq
// [0-100],[1-101]
array([-0.57387128, -0.40206378, -0.55946735, -0.60425452, -0.44742511,
       -0.58419515, -0.61932266, -0.69295419, -0.58351166, -0.54994044,
       -0.43662703, -0.61914435, -0.85068306, -0.48820822, -0.49690824,
       -0.60852687, -0.30539302, -0.67166959, -0.81256915, -0.72588739,
       -0.63647265, -0.35187454, -0.48203332, -0.46631505, -0.20902319,
       -0.55609022, -0.60737069, -0.63376441, -0.62251862, -0.83177698,
       -0.69605854, -0.59591266, -0.64712982, -0.72117908, -0.56725734,
       -0.49523732, -0.28346511, -0.40331179, -0.22654798, -0.49355597,
       -0.40401442, -0.55644669, -0.51327605, -0.54594082, -0.67255346,
       -0.5768457 , -0.68445274, -0.68570625, -0.50959873, -0.53279995,
       -0.69369626, -0.77043888, -0.47404523, -0.53040862, -0.55402487,
       -0.52105681, -0.6572804 , -0.32012793, -0.45812272, -0.53512967,
       -0.44819954, -0.62960976, -0.5902882 , -0.54241652, -0.5205725 ,
       -0.52635618, -0.70176632, -0.60213327, -0.61924325, -0.43668441,
       -0.45742335, -0.41136202, -0.39301151, -0.80772151, -0.6156968 ,
       -0.53395663, -0.60273659, -0.36046779, -0.50490417, -0.44372466,
       -0.4931788 , -0.4855132 , -0.41544793, -0.4899432 , -0.34648403,
       -0.58506004, -0.59291681, -0.53426938, -0.41909785, -0.4734859 ,
       -0.49628204, -0.42389299, -0.5318    , -0.62608821, -0.4355949 ,
       -0.44864787, -0.35575533, -0.52354333, -0.55667681, -0.6139897 ])

// train_label
array([-0.40206378, -0.55946735, -0.60425452, -0.44742511, -0.58419515,
       -0.61932266, -0.69295419, -0.58351166, -0.54994044, -0.43662703,
       -0.61914435, -0.85068306, -0.48820822, -0.49690824, -0.60852687,
       -0.30539302, -0.67166959, -0.81256915, -0.72588739, -0.63647265,
       -0.35187454, -0.48203332, -0.46631505, -0.20902319, -0.55609022,
       -0.60737069, -0.63376441, -0.62251862, -0.83177698, -0.69605854,
       -0.59591266, -0.64712982, -0.72117908, -0.56725734, -0.49523732,
       -0.28346511, -0.40331179, -0.22654798, -0.49355597, -0.40401442,
       -0.55644669, -0.51327605, -0.54594082, -0.67255346, -0.5768457 ,
       -0.68445274, -0.68570625, -0.50959873, -0.53279995, -0.69369626,
       -0.77043888, -0.47404523, -0.53040862, -0.55402487, -0.52105681,
       -0.6572804 , -0.32012793, -0.45812272, -0.53512967, -0.44819954,
       -0.62960976, -0.5902882 , -0.54241652, -0.5205725 , -0.52635618,
       -0.70176632, -0.60213327, -0.61924325, -0.43668441, -0.45742335,
       -0.41136202, -0.39301151, -0.80772151, -0.6156968 , -0.53395663,
       -0.60273659, -0.36046779, -0.50490417, -0.44372466, -0.4931788 ,
       -0.4855132 , -0.41544793, -0.4899432 , -0.34648403, -0.58506004,
       -0.59291681, -0.53426938, -0.41909785, -0.4734859 , -0.49628204,
       -0.42389299, -0.5318    , -0.62608821, -0.4355949 , -0.44864787,
       -0.35575533, -0.52354333, -0.55667681, -0.6139897 , -0.50292192])

// 训练集的一个输入和输出
[(array([-0.57387128, -0.40206378, -0.55946735, -0.60425452, -0.44742511,
       -0.58419515, -0.61932266, -0.69295419, -0.58351166, -0.54994044,
       -0.43662703, -0.61914435, -0.85068306, -0.48820822, -0.49690824,
       -0.60852687, -0.30539302, -0.67166959, -0.81256915, -0.72588739,
       -0.63647265, -0.35187454, -0.48203332, -0.46631505, -0.20902319,
       -0.55609022, -0.60737069, -0.63376441, -0.62251862, -0.83177698,
       -0.69605854, -0.59591266, -0.64712982, -0.72117908, -0.56725734,
       -0.49523732, -0.28346511, -0.40331179, -0.22654798, -0.49355597,
       -0.40401442, -0.55644669, -0.51327605, -0.54594082, -0.67255346,
       -0.5768457 , -0.68445274, -0.68570625, -0.50959873, -0.53279995,
       -0.69369626, -0.77043888, -0.47404523, -0.53040862, -0.55402487,
       -0.52105681, -0.6572804 , -0.32012793, -0.45812272, -0.53512967,
       -0.44819954, -0.62960976, -0.5902882 , -0.54241652, -0.5205725 ,
       -0.52635618, -0.70176632, -0.60213327, -0.61924325, -0.43668441,
       -0.45742335, -0.41136202, -0.39301151, -0.80772151, -0.6156968 ,
       -0.53395663, -0.60273659, -0.36046779, -0.50490417, -0.44372466,
       -0.4931788 , -0.4855132 , -0.41544793, -0.4899432 , -0.34648403,
       -0.58506004, -0.59291681, -0.53426938, -0.41909785, -0.4734859 ,
       -0.49628204, -0.42389299, -0.5318    , -0.62608821, -0.4355949 ,
       -0.44864787, -0.35575533, -0.52354333, -0.55667681, -0.6139897 ]), array([-0.40206378, -0.55946735, -0.60425452, -0.44742511, -0.58419515,
       -0.61932266, -0.69295419, -0.58351166, -0.54994044, -0.43662703,
       -0.61914435, -0.85068306, -0.48820822, -0.49690824, -0.60852687,
       -0.30539302, -0.67166959, -0.81256915, -0.72588739, -0.63647265,
       -0.35187454, -0.48203332, -0.46631505, -0.20902319, -0.55609022,
       -0.60737069, -0.63376441, -0.62251862, -0.83177698, -0.69605854,
       -0.59591266, -0.64712982, -0.72117908, -0.56725734, -0.49523732,
       -0.28346511, -0.40331179, -0.22654798, -0.49355597, -0.40401442,
       -0.55644669, -0.51327605, -0.54594082, -0.67255346, -0.5768457 ,
       -0.68445274, -0.68570625, -0.50959873, -0.53279995, -0.69369626,
       -0.77043888, -0.47404523, -0.53040862, -0.55402487, -0.52105681,
       -0.6572804 , -0.32012793, -0.45812272, -0.53512967, -0.44819954,
       -0.62960976, -0.5902882 , -0.54241652, -0.5205725 , -0.52635618,
       -0.70176632, -0.60213327, -0.61924325, -0.43668441, -0.45742335,
       -0.41136202, -0.39301151, -0.80772151, -0.6156968 , -0.53395663,
       -0.60273659, -0.36046779, -0.50490417, -0.44372466, -0.4931788 ,
       -0.4855132 , -0.41544793, -0.4899432 , -0.34648403, -0.58506004,
       -0.59291681, -0.53426938, -0.41909785, -0.4734859 , -0.49628204,
       -0.42389299, -0.5318    , -0.62608821, -0.4355949 , -0.44864787,
       -0.35575533, -0.52354333, -0.55667681, -0.6139897 , -0.50292192]))]
```

**所以2000长度的数据，总共可以生成1900个数据，每个数据中包含两个窗口的数据，各长100，即(1900,2,100)**

- 然后将数据减去预测窗口（output_target）大小，即1900-1=1899

```json
tensor([
    	[[-0.5739, -0.4021, -0.5595,  ..., -0.5235, -0.5567, -0.6140],
         [-0.4021, -0.5595, -0.6043,  ..., -0.5567, -0.6140, -0.5029]],

        [[-0.4021, -0.5595, -0.6043,  ..., -0.5567, -0.6140, -0.5029],
         [-0.5595, -0.6043, -0.4474,  ..., -0.6140, -0.5029, -0.6021]],

        [[-0.5595, -0.6043, -0.4474,  ..., -0.6140, -0.5029, -0.6021],
         [-0.6043, -0.4474, -0.5842,  ..., -0.5029, -0.6021, -0.5862]],

        ...,

        [[-0.6140, -0.5029, -0.6021,  ..., -0.4409, -0.4944, -0.6812],
         [-0.5029, -0.6021, -0.5862,  ..., -0.4944, -0.6812, -0.5717]],

        [[-0.5029, -0.6021, -0.5862,  ..., -0.4944, -0.6812, -0.5717],
         [-0.6021, -0.5862, -0.5648,  ..., -0.6812, -0.5717, -0.8837]],

        [[-0.6021, -0.5862, -0.5648,  ..., -0.6812, -0.5717, -0.8837],
         [-0.5862, -0.5648, -0.2523,  ..., -0.5717, -0.8837, -0.6390]]
])
```

# 模型

## 位置编码

> 维度就是列

pe是5000个维度为d_model（250）的tensor

```json
tensor([
    	[ 0.0000e+00,  1.0000e+00,  0.0000e+00,  ...,  1.0000e+00,
          0.0000e+00,  1.0000e+00],
        [ 8.4147e-01,  5.4030e-01,  8.0100e-01,  ...,  1.0000e+00,
          1.0765e-04,  1.0000e+00],
        [ 9.0930e-01, -4.1615e-01,  9.5906e-01,  ...,  1.0000e+00,
          2.1529e-04,  1.0000e+00],
        ...,
        [ 9.5625e-01, -2.9254e-01, -9.4216e-01,  ...,  8.3699e-01,
          5.1234e-01,  8.5878e-01],
        [ 2.7050e-01, -9.6272e-01, -2.9535e-01,  ...,  8.3692e-01,
          5.1243e-01,  8.5873e-01],
        [-6.6395e-01, -7.4778e-01,  5.8825e-01,  ...,  8.3686e-01,
          5.1253e-01,  8.5867e-01]
       ])
```

position则是5000个1维的tensor，**用于给pe的每一个维度（250）填充值**

- 值从1到4999

```json
tensor([[0.0000e+00],
        [1.0000e+00],
        [2.0000e+00],
        ...,
        [4.9970e+03],
        [4.9980e+03],
        [4.9990e+03]])
```

填充pe后，**改变pe的维度，变成(5000,1,250)**

> 即5000个数据，每个数据是一个250维的tensor

```json
tensor([
    	[
            [ 0.0000e+00,  1.0000e+00,  0.0000e+00,  ...,  1.0000e+00,
           0.0000e+00,  1.0000e+00]
        ],

        [
            [ 8.4147e-01,  5.4030e-01,  8.0100e-01,  ...,  1.0000e+00,
           1.0765e-04,  1.0000e+00]
        ],

        [
            [ 9.0930e-01, -4.1615e-01,  9.5906e-01,  ...,  1.0000e+00,
           2.1529e-04,  1.0000e+00]
        ],

        ...,

        [
    		[ 9.5625e-01, -2.9254e-01, -9.4216e-01,  ...,  8.3699e-01,
           5.1234e-01,  8.5878e-01]
       ],

        [
       		[ 2.7050e-01, -9.6272e-01, -2.9535e-01,  ...,  8.3692e-01,
           5.1243e-01,  8.5873e-01]
		],

        [
            [-6.6395e-01, -7.4778e-01,  5.8825e-01,  ...,  8.3686e-01,
           5.1253e-01,  8.5867e-01]
        ]
])
```

# 训练

## epoch

epochs = 100，**从第一个epoch到第100个epoch，每个epoch都是拿一整个完整的数据集进行训练，训练次数为：数据集长度/batch_size**

> 进入model.trainI()函数

```python
# 标准写法
for batch, i in enumerate(range(0, len(train_data) - 1, batch_size)):
    data, targets = get_batch(train_data, i, batch_size)
```

**batch_size = 20，每次从训练集中取20个数据，即(20,2,100)**，不足20则取剩余的

- (batch,i)：(0,0),(1,20),(2,40)...以batch_size大小增长

```json
tensor([[[-0.5161, -0.5684, -0.5169,  ..., -0.5884, -0.7686, -0.4507],
         [-0.5684, -0.5169, -0.6286,  ..., -0.7686, -0.4507, -0.5368]],

        [[-0.5684, -0.5169, -0.6286,  ..., -0.7686, -0.4507, -0.5368],
         [-0.5169, -0.6286, -0.3985,  ..., -0.4507, -0.5368, -0.4574]],

        [[-0.5169, -0.6286, -0.3985,  ..., -0.4507, -0.5368, -0.4574],
         [-0.6286, -0.3985, -0.5671,  ..., -0.5368, -0.4574, -0.6373]],

        ...,

        [[-0.8046, -0.4976, -0.8442,  ..., -0.7260, -0.6980, -0.5960],
         [-0.4976, -0.8442, -0.6934,  ..., -0.6980, -0.5960, -0.5318]],

        [[-0.4976, -0.8442, -0.6934,  ..., -0.6980, -0.5960, -0.5318],
         [-0.8442, -0.6934, -0.8517,  ..., -0.5960, -0.5318, -0.4263]],

        [[-0.8442, -0.6934, -0.8517,  ..., -0.5960, -0.5318, -0.4263],
         [-0.6934, -0.8517, -0.7266,  ..., -0.5318, -0.4263, -0.6205]]],
       device='cuda:0')
```

从训练集(20,2,100)中获取本次的输入

- 20个数据中，每个数据的**第一个列表数据是输入[0-100]**
- 20个数据中，每个数据的**第二个列表数据是输出[1-101]**

转换为列后，是(100,20,1)

**这个(100,20,1)的in数据，就是输入到网络中的数据**

```json
// in
tensor([[[-0.5161],
         [-0.5684],
         [-0.5169],
         ...,
         [-0.8046],
         [-0.4976],
         [-0.8442]],

        [[-0.5684],
         [-0.5169],
         [-0.6286],
         ...,
         [-0.4976],
         [-0.8442],
         [-0.6934]],

        [[-0.5169],
         [-0.6286],
         [-0.3985],
         ...,
         [-0.8442],
         [-0.6934],
         [-0.8517]],

        ...,

        [[-0.5884],
         [-0.7686],
         [-0.4507],
         ...,
         [-0.7260],
         [-0.6980],
         [-0.5960]],

        [[-0.7686],
         [-0.4507],
         [-0.5368],
         ...,
         [-0.6980],
         [-0.5960],
         [-0.5318]],

        [[-0.4507],
         [-0.5368],
         [-0.4574],
         ...,
         [-0.5960],
         [-0.5318],
         [-0.4263]]], device='cuda:0')
// out
tensor([[[-0.5684],
         [-0.5169],
         [-0.6286],
         ...,
         [-0.4976],
         [-0.8442],
         [-0.6934]],

        [[-0.5169],
         [-0.6286],
         [-0.3985],
         ...,
         [-0.8442],
         [-0.6934],
         [-0.8517]],

        [[-0.6286],
         [-0.3985],
         [-0.5671],
         ...,
         [-0.6934],
         [-0.8517],
         [-0.7266]],

        ...,

        [[-0.7686],
         [-0.4507],
         [-0.5368],
         ...,
         [-0.6980],
         [-0.5960],
         [-0.5318]],

        [[-0.4507],
         [-0.5368],
         [-0.4574],
         ...,
         [-0.5960],
         [-0.5318],
         [-0.4263]],

        [[-0.5368],
         [-0.4574],
         [-0.6373],
         ...,
         [-0.5318],
         [-0.4263],
         [-0.6205]]], device='cuda:0')
```

## 掩码

生成一个**上三角矩阵mask，(100,100)**

```json
tensor([[0., -inf, -inf,  ..., -inf, -inf, -inf],
        [0., 0., -inf,  ..., -inf, -inf, -inf],
        [0., 0., 0.,  ..., -inf, -inf, -inf],
        ...,
        [0., 0., 0.,  ..., 0., -inf, -inf],
        [0., 0., 0.,  ..., 0., 0., -inf],
        [0., 0., 0.,  ..., 0., 0., 0.]])
```

## forward

输入后先传播到位置编码的forward中

pe是一个(5000,1,250)的数据，但输入in是一个(100,20,1)的数据

所以取in.size(0)，即100对pe进行划分，得到(100,1,250)的数据，加到in上

in变成一个(100,20,250)的数据

```json
// 添加位置编码后的输入in
tensor([[[-0.5161,  0.4839, -0.5161,  ...,  0.4839, -0.5161,  0.4839],
         [-0.5684,  0.4316, -0.5684,  ...,  0.4316, -0.5684,  0.4316],
         [-0.5169,  0.4831, -0.5169,  ...,  0.4831, -0.5169,  0.4831],
         ...,
         [-0.8046,  0.1954, -0.8046,  ...,  0.1954, -0.8046,  0.1954],
         [-0.4976,  0.5024, -0.4976,  ...,  0.5024, -0.4976,  0.5024],
         [-0.8442,  0.1558, -0.8442,  ...,  0.1558, -0.8442,  0.1558]],

        [[ 0.2731, -0.0281,  0.2326,  ...,  0.4316, -0.5682,  0.4316],
         [ 0.3246,  0.0234,  0.2841,  ...,  0.4831, -0.5168,  0.4831],
         [ 0.2128, -0.0883,  0.1724,  ...,  0.3714, -0.6285,  0.3714],
         ...,
         [ 0.3439,  0.0427,  0.3034,  ...,  0.5024, -0.4975,  0.5024],
         [-0.0027, -0.3039, -0.0432,  ...,  0.1558, -0.8441,  0.1558],
         [ 0.1480, -0.1531,  0.1076,  ...,  0.3066, -0.6933,  0.3066]],

        [[ 0.3924, -0.9330,  0.4422,  ...,  0.4831, -0.5167,  0.4831],
         [ 0.2807, -1.0448,  0.3304,  ...,  0.3714, -0.6284,  0.3714],
         [ 0.5108, -0.8146,  0.5606,  ...,  0.6015, -0.3983,  0.6015],
         ...,
         [ 0.0651, -1.2603,  0.1149,  ...,  0.1558, -0.8440,  0.1558],
         [ 0.2159, -1.1096,  0.2656,  ...,  0.3066, -0.6932,  0.3066],
         [ 0.0576, -1.2679,  0.1073,  ...,  0.1483, -0.8515,  0.1483]],

        ...,

        [[-0.2088, -1.5136,  0.2511,  ...,  0.4115, -0.5780,  0.4115],
         [-0.3890, -1.6938,  0.0709,  ...,  0.2313, -0.7582,  0.2313],
         [-0.0711, -1.3758,  0.3888,  ...,  0.5492, -0.4403,  0.5493],
         ...,
         [-0.3464, -1.6511,  0.1136,  ...,  0.2740, -0.7155,  0.2740],
         [-0.3184, -1.6232,  0.1415,  ...,  0.3019, -0.6876,  0.3019],
         [-0.2164, -1.5212,  0.2435,  ...,  0.4039, -0.5856,  0.4039]],

        [[-1.3420, -1.5879, -0.7012,  ...,  0.2313, -0.7581,  0.2313],
         [-1.0241, -1.2700, -0.3833,  ...,  0.5492, -0.4401,  0.5492],
         [-1.1102, -1.3561, -0.4694,  ...,  0.4631, -0.5263,  0.4631],
         ...,
         [-1.2714, -1.5173, -0.6306,  ...,  0.3019, -0.6875,  0.3019],
         [-1.1694, -1.4153, -0.5286,  ...,  0.4039, -0.5855,  0.4039],
         [-1.1052, -1.3511, -0.4644,  ...,  0.4681, -0.5213,  0.4681]],

        [[-1.4499, -0.4109, -1.2095,  ...,  0.5492, -0.4400,  0.5492],
         [-1.5360, -0.4970, -1.2956,  ...,  0.4631, -0.5262,  0.4631],
         [-1.4566, -0.4176, -1.2162,  ...,  0.5425, -0.4467,  0.5425],
         ...,
         [-1.5952, -0.5562, -1.3548,  ...,  0.4039, -0.5854,  0.4039],
         [-1.5311, -0.4920, -1.2907,  ...,  0.4681, -0.5212,  0.4681],
         [-1.4255, -0.3864, -1.1851,  ...,  0.5737, -0.4156,  0.5737]]],
       device='cuda:0')
```

再进入encoder中

in依旧是一个(100,20,250)的数据

```json
tensor([[[-0.9860,  1.4549, -0.5863,  ...,  0.7547, -0.8560,  0.6348],
         [-1.1977,  1.6100, -0.6696,  ...,  0.8074, -0.6878,  0.5937],
         [-1.4577,  1.4083, -0.6364,  ...,  1.1334, -0.5294,  0.4869],
         ...,
         [-1.1347,  0.4049,  0.0073,  ...,  0.4853, -0.6947,  0.4562],
         [-1.3624,  1.1277, -0.8822,  ...,  0.8259, -1.0095,  0.5552],
         [-1.2334,  1.6753, -0.7525,  ...,  0.9711, -0.3761,  0.3268]],

        [[ 0.1826,  0.6501,  0.7719,  ...,  1.0858, -1.1150,  0.4773],
         [ 0.1684,  1.0679,  0.7394,  ...,  1.0630, -1.0512,  0.5670],
         [ 0.1491,  1.1002,  0.7501,  ...,  0.9424, -0.7955,  1.0871],
         ...,
         [ 0.4979,  0.6830,  1.1991,  ...,  1.0741, -1.0546,  0.1389],
         [ 0.0785,  0.7723, -0.1703,  ...,  1.1660, -0.6914,  0.5123],
         [ 0.2605,  0.6612,  0.7932,  ...,  0.8354, -0.9284,  0.2744]],

        [[ 0.5926, -1.5333,  1.0270,  ...,  0.5408, -0.6057,  1.0573],
         [ 0.4862, -1.2018,  0.2325,  ...,  0.7061, -0.7060,  0.7700],
         [ 0.2921, -2.2663,  1.1903,  ...,  0.7084, -0.7757,  0.9924],
         ...,
         [ 0.3766, -1.2757,  0.7826,  ...,  0.6579, -0.9040,  0.5178],
         [ 0.5746, -1.2710,  1.1072,  ...,  0.5912, -0.8151,  0.4637],
         [ 0.3280, -2.2059,  0.8934,  ...,  0.6481, -0.3552,  0.4790]],

        ...,

        [[-0.1850, -1.0882,  1.0251,  ...,  1.3383, -0.2696,  0.9187],
         [-0.0775, -0.9473,  1.0650,  ...,  1.1225,  0.2002,  0.9088],
         [-0.2040, -1.1715,  1.4754,  ...,  0.7107,  0.2010,  0.8810],
         ...,
         [ 0.1238, -1.2066,  0.1894,  ...,  1.1650, -0.2350,  1.1211],
         [-0.1642, -1.2181,  0.9809,  ...,  1.0987,  0.2132,  1.0066],
         [-0.1010, -1.2287,  0.9529,  ...,  1.1500,  0.1023,  1.0381]],

        [[-1.5313, -0.9177, -0.1623,  ...,  1.0885,  0.1501,  1.1088],
         [-1.5778, -1.0709, -0.1237,  ...,  1.2339,  0.1552,  0.9182],
         [-1.6446, -0.9662, -0.1449,  ...,  0.6577,  0.2154,  1.0677],
         ...,
         [-1.5515, -0.8109, -0.2435,  ...,  1.0433,  0.0509,  1.2033],
         [-1.6830, -1.0061,  0.3854,  ...,  0.6131,  0.0752,  1.1032],
         [-1.4651, -1.1838, -0.2480,  ...,  1.1751,  0.1961,  1.0650]],

        [[-2.1493,  0.2221, -1.3728,  ...,  1.1773,  0.1187,  0.9726],
         [-1.8473,  0.2098, -1.4540,  ...,  1.3061, -0.0753,  1.2810],
         [-1.9592,  0.2191, -1.3524,  ...,  1.3175,  0.0681,  0.9768],
         ...,
         [-1.8302,  0.1964, -0.8726,  ...,  1.2006, -0.0210,  1.0308],
         [-2.2398,  0.2965, -1.3614,  ...,  0.7164,  0.0444,  1.0879],
         [-2.1661,  0.3775, -1.5071,  ...,  1.3114, -0.0711,  0.8497]]],
       device='cuda:0', grad_fn=<NativeLayerNormBackward>)
```

最后进入decoder中

in会输出一个(100,20,1)的数据，这就是本次训练的结果

```json
tensor([[[1.7166],
         [1.5955],
         [1.3612],
         ...,
         [1.2925],
         [0.9609],
         [1.1833]],

        [[1.4403],
         [1.3335],
         [1.7375],
         ...,
         [1.8072],
         [1.2017],
         [1.4680]],

        [[1.6215],
         [1.5733],
         [1.0512],
         ...,
         [1.6895],
         [1.3844],
         [1.1320]],

        ...,

        [[0.3132],
         [0.4665],
         [0.4616],
         ...,
         [0.4908],
         [0.3903],
         [0.5183]],

        [[0.7226],
         [0.4793],
         [0.5261],
         ...,
         [0.5081],
         [0.6604],
         [0.7706]],

        [[0.6698],
         [0.7162],
         [0.8714],
         ...,
         [0.9011],
         [0.5640],
         [0.9288]]], device='cuda:0', grad_fn=<AddBackward0>)
```

## loss

计算本次的loss

跟上面的(100,20,1)的out数据做计算，得到loss

```json
// out
tensor([[[-0.5684],
         [-0.5169],
         [-0.6286],
         ...,
         [-0.4976],
         [-0.8442],
         [-0.6934]],

        [[-0.5169],
         [-0.6286],
         [-0.3985],
         ...,
         [-0.8442],
         [-0.6934],
         [-0.8517]],

        [[-0.6286],
         [-0.3985],
         [-0.5671],
         ...,
         [-0.6934],
         [-0.8517],
         [-0.7266]],

        ...,

        [[-0.7686],
         [-0.4507],
         [-0.5368],
         ...,
         [-0.6980],
         [-0.5960],
         [-0.5318]],

        [[-0.4507],
         [-0.5368],
         [-0.4574],
         ...,
         [-0.5960],
         [-0.5318],
         [-0.4263]],

        [[-0.5368],
         [-0.4574],
         [-0.6373],
         ...,
         [-0.5318],
         [-0.4263],
         [-0.6205]]], device='cuda:0')
```

## log

一个epoch会拿一整个完整的数据集分batch_size大小进行训练，所以训练次数为：**数据集长度/batch_size**

如果每5次打印一次日志，并计算这5次的平均loss

即间隔为：`log_interval = int(len(train_data) / batch_size / 5)`

> 每个epoch总共训练95伦，每5伦打印一次日志，总共18次

```json
print('|epoch{:3d}|{:5d}/{:5d} batches | '
      'lr {:02.6f} | {:5.2f} ms | '
      'loss {:5.5f} | ppl {:8.2f}'.format(epoch, batch, len(train_data), batch_size, scheduler.get_lr()[0], elapsed * 1000 / log_interval, cur_loss, math.exp(cur_loss)))

// 打印结果
| epoch 1 | 18/ 94 batches | lr 0.005000 | 162151.81 ms | loss 0.69152 | ppl 2.00
| epoch 1 | 36/ 94 batches | lr 0.005000 | 418.42 ms | loss 0.16171 | ppl     1.18
```

